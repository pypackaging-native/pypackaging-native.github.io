
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../geospatial_stack/">
      
      
        <link rel="next" href="../../abi/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.6">
    
    
      
        <title>Complex C++ dependencies - pypackaging-native</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#complex-c-dependencies" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="pypackaging-native" class="md-header__button md-logo" aria-label="pypackaging-native" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pypackaging-native
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Complex C++ dependencies
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pypackaging-native/pypackaging-native" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="pypackaging-native" class="md-nav__button md-logo" aria-label="pypackaging-native" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    pypackaging-native
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pypackaging-native/pypackaging-native" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" tabindex="0" aria-expanded="false">
          Meta topics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Meta topics" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Meta topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../meta-topics/build_steps_conceptual/" class="md-nav__link">
        Build & package management concepts and terminology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../meta-topics/purposes_of_pypi/" class="md-nav__link">
        The multiple purposes of PyPI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../meta-topics/pypi_social_model/" class="md-nav__link">
        PyPI's author-led social model and its limitations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../meta-topics/no_build_farm/" class="md-nav__link">
        Lack of a build farm for PyPI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../meta-topics/user_expectations_wheels/" class="md-nav__link">
        Expectations that projects provide ever more wheels
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" tabindex="0" aria-expanded="true">
          Key issues
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Key issues" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Key issues
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3_1" tabindex="0" aria-expanded="true">
          Native dependencies
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Native dependencies" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Native dependencies
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Native dependencies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../blas_openmp/" class="md-nav__link">
        BLAS, LAPACK and OpenMP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../geospatial_stack/" class="md-nav__link">
        The Geospatial stack
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Complex C++ dependencies
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Complex C++ dependencies
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#current-state" class="md-nav__link">
    Current state
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problems" class="md-nav__link">
    Problems
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#history" class="md-nav__link">
    History
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relevant-resources" class="md-nav__link">
    Relevant resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#potential-solutions-or-mitigations" class="md-nav__link">
    Potential solutions or mitigations
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../abi/" class="md-nav__link">
        Depending on packages for which an ABI matters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gpus/" class="md-nav__link">
        Packaging projects with GPU code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pypi_metadata_handling/" class="md-nav__link">
        Metadata handling on PyPI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../simd_support/" class="md-nav__link">
        Distributing a package containing SIMD code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../unexpected_fromsource_builds/" class="md-nav__link">
        Unsuspecting users getting failing from-source builds
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../other_issues/" class="md-nav__link">
        Other issues
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" tabindex="0" aria-expanded="false">
          Background
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Background" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Background
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../background/binary_interface/" class="md-nav__link">
        Application Binary Interface (ABI)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../background/compilation_concepts/" class="md-nav__link">
        Basic code compilation concepts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../glossary/" class="md-nav__link">
        Glossary
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#current-state" class="md-nav__link">
    Current state
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problems" class="md-nav__link">
    Problems
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#history" class="md-nav__link">
    History
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relevant-resources" class="md-nav__link">
    Relevant resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#potential-solutions-or-mitigations" class="md-nav__link">
    Potential solutions or mitigations
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="complex-c-dependencies">Complex C++ dependencies</h1>
<p>Projects with a large amount of C++ code and dependencies include
<a href="https://www.tensorflow.org/">TensorFlow</a>,
<a href="https://pytorch.org/">PyTorch</a>,
<a href="https://arrow.apache.org/">Apache Arrow</a>,
<a href="https://mxnet.apache.org">Apache MXNet</a>,
<a href="https://github.com/rapidsai/cudf">cuDF</a>,
<a href="https://www.ray.io/">Ray</a>,
<a href="https://root.cern/">ROOT</a>, and
<a href="https://vaex.io">Vaex</a>.
Many other projects include some C++ components, like:
<a href="https://github.com/scikit-learn/scikit-learn/">scikit-learn</a>,
<a href="https://scipy.org/">SciPy</a>,
<a href="https://numpy.org/">NumPy</a>,
<a href="https://cupy.dev/">CuPy</a>, and
<a href="https://awkward-array.org/doc/main/">Awkward Array</a>.</p>
<p>To get an impression of the number and type of external dependencies that some
of these projects have, outside of their own large code bases, one can look at
the "third party" directories in their repositories:
<a href="https://github.com/pytorch/pytorch/tree/master/third_party">pytorch/third_party</a>,
<a href="https://github.com/tensorflow/tensorflow/tree/master/third_party">tensorflow/third_party</a>,
<a href="https://github.com/apache/mxnet/tree/master/3rdparty">mxnet/3rdparty</a>.</p>
<p>There are usually more build time dependencies that are specified elsewhere - some
on PyPI, some only listed in the documentation. Projects with dependencies like
that tend to not upload any sdist's to PyPI (users will see too many build
failures, see <a href="../../../meta-topics/purposes_of_pypi/">purposes of PyPI</a> for
context), and have a hard time building wheels because of the requirement that
a wheel must be self-contained - which means a lot of vendoring and potential
issues.</p>
<h2 id="current-state">Current state</h2>
<p>Wheels tend to work fine for packages that have some C, C++ or Cython code but
no external dependencies other than Python packages. Once a project has
dependencies on other C++ libraries, it has to build that other library and
vendor it as part of building its own wheel. Tools like <code>auditwheel</code>,
<code>delocate</code> and <code>delvewheel</code> help with the vendoring part, but building
everything in a consistent fashion is (a) a lot of work, and (b) may be very
difficult.</p>
<div class="admonition quote">
<p class="admonition-title">Why are wheels hard - Wes McKinney</p>
<p>The Python wheel binary standard was optimized for easy installation
of packages with C extensions, but where those C extensions are simple
to build. The best case scenario is that the C code is completely
self-contained.</p>
<p>If things are more complicated, things get messy:</p>
<ul>
<li>Third party C libraries</li>
<li>Third party C++ libraries</li>
<li>Differing C++ ABI versions</li>
</ul>
<p>The constraint of wheels is that a package must generally be entirely
self-contained, including all C/C++ symbols included via static
linking or by including the shared library bundled in the wheel --
which style of bundling works best may be different for Linux, macOS,
and Windows.</p>
</div>
<p>Only very recently (Oct '22) was the requirement for wheels to be fully
self-contained loosened a little, allowing package authors to take
responsibility for the quality of their own wheels and avoiding vendoring of
libraries that are very large or had to be vendored into multiple wheels that
they have control over:
<a href="https://github.com/pypa/auditwheel/pull/368">auditwheel#368</a>. That change is
an improvement, but doesn't change the big picture - package authors still
cannot rely on other native dependencies on the system easily, and may have to
maintain their own separate wheels (e.g., if SciPy and NumPy want to rely on a
shared <code>libopenblas</code> wheel, they are the ones who have to do all the work for
that).</p>
<div class="admonition example">
<p class="admonition-title">Example: PyArrow</p>
<p>PyArrow is the Python API of Apache Arrow. Apache Arrow is a C++ project
with many C and C++ dependencies. Large and complicated ones. In 2019 the
need to vendor the likes of OpenSLL, gRPC, and Gandiva (which in turn
relies on LLVM) made it too hard to build wheels for PyPI at all - because
all dependencies must  be built from source and vendored into a wheel,
which is a major endeavour. As of Dec 2022, there are wheels again, without
OpenSSL and Gandiva in them.
<em>TODO: figure out in more detail what changed here</em></p>
<p>To understand the C/C++ dependencies of PyArrow, let's look at the
dependency tree in conda-forge and at the libraries vendored into a
manylinux wheel on PyPI:</p>
<details class="note">
<summary>PyArrow dependency tree (conda-forge)</summary>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span><span class="c1"># Note: output edited to remove duplicate packages and python/numpy dependencies</span>
$<span class="w"> </span>mamba<span class="w"> </span>repoquery<span class="w"> </span>depends<span class="w"> </span>pyarrow<span class="w"> </span>--tree

pyarrow<span class="o">[</span><span class="m">9</span>.0.0<span class="o">]</span>
<span class="w">  </span>├─<span class="w"> </span>libgcc-ng<span class="o">[</span><span class="m">12</span>.2.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">  </span>├─<span class="w"> </span>_openmp_mutex<span class="o">[</span><span class="m">4</span>.5<span class="o">]</span>
<span class="w">  </span>│<span class="w">  </span>│<span class="w">  </span>├─<span class="w"> </span>_libgcc_mutex<span class="o">[</span><span class="m">0</span>.1<span class="o">]</span>
<span class="w">  </span>│<span class="w">  </span>│<span class="w">  </span>└─<span class="w"> </span>libgomp<span class="o">[</span><span class="m">12</span>.2.0<span class="o">]</span>
<span class="w">  </span>├─<span class="w"> </span>libstdcxx-ng<span class="o">[</span><span class="m">12</span>.2.0<span class="o">]</span>
<span class="w">  </span>├─<span class="w"> </span>numpy<span class="o">[</span><span class="m">1</span>.23.5<span class="o">]</span>
<span class="w">  </span>├─<span class="w"> </span>parquet-cpp<span class="o">[</span><span class="m">1</span>.5.1<span class="o">]</span>
<span class="w">  </span>│<span class="w">  </span>└─<span class="w"> </span>arrow-cpp<span class="o">[</span><span class="m">9</span>.0.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>gflags<span class="o">[</span><span class="m">2</span>.2.2<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>c-ares<span class="o">[</span><span class="m">1</span>.18.1<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>libbrotlienc<span class="o">[</span><span class="m">1</span>.0.9<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>└─<span class="w"> </span>libbrotlicommon<span class="o">[</span><span class="m">1</span>.0.9<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>libbrotlidec<span class="o">[</span><span class="m">1</span>.0.9<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>zstd<span class="o">[</span><span class="m">1</span>.5.2<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>aws-sdk-cpp<span class="o">[</span><span class="m">1</span>.8.186<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>├─<span class="w"> </span>aws-c-event-stream<span class="o">[</span><span class="m">0</span>.2.7<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">  </span>├─<span class="w"> </span>aws-c-common<span class="o">[</span><span class="m">0</span>.6.2<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">  </span>├─<span class="w"> </span>aws-checksums<span class="o">[</span><span class="m">0</span>.1.11<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">  </span>└─<span class="w"> </span>aws-c-io<span class="o">[</span><span class="m">0</span>.10.5<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>aws-c-cal<span class="o">[</span><span class="m">0</span>.5.11<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">     </span>└─<span class="w"> </span>s2n<span class="o">[</span><span class="m">1</span>.0.10<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>├─<span class="w"> </span>libcurl<span class="o">[</span><span class="m">7</span>.86.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">  </span>├─<span class="w"> </span>krb5<span class="o">[</span><span class="m">1</span>.19.3<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">  </span>│<span class="w">  </span>├─<span class="w"> </span>libedit<span class="o">[</span><span class="m">3</span>.1.20191231<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">  </span>│<span class="w">  </span>└─<span class="w"> </span>keyutils<span class="o">[</span><span class="m">1</span>.6.1<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">  </span>├─<span class="w"> </span>libssh2<span class="o">[</span><span class="m">1</span>.10.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">  </span>└─<span class="w"> </span>libnghttp2<span class="o">[</span><span class="m">1</span>.47.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>│<span class="w">     </span>└─<span class="w"> </span>libev<span class="o">[</span><span class="m">4</span>.33<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>lz4-c<span class="o">[</span><span class="m">1</span>.9.3<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>libthrift<span class="o">[</span><span class="m">0</span>.16.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>└─<span class="w"> </span>libevent<span class="o">[</span><span class="m">2</span>.1.10<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>libutf8proc<span class="o">[</span><span class="m">2</span>.8.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>snappy<span class="o">[</span><span class="m">1</span>.1.9<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>re2<span class="o">[</span><span class="m">2022</span>.06.01<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>glog<span class="o">[</span><span class="m">0</span>.6.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>libabseil<span class="o">[</span><span class="m">20220623</span>.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>libprotobuf<span class="o">[</span><span class="m">3</span>.21.10<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>orc<span class="o">[</span><span class="m">1</span>.8.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>├─<span class="w"> </span>libgrpc<span class="o">[</span><span class="m">1</span>.49.1<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>│<span class="w">  </span>├─<span class="w"> </span>zlib<span class="o">[</span><span class="m">1</span>.2.13<span class="o">]</span>
<span class="w">  </span>│<span class="w">     </span>└─<span class="w"> </span>libgoogle-cloud<span class="o">[</span><span class="m">2</span>.3.0<span class="o">]</span>
<span class="w">  </span>│<span class="w">        </span>├─<span class="w"> </span>libcrc32c<span class="o">[</span><span class="m">1</span>.1.2<span class="o">]</span>
<span class="w">  </span>├─<span class="w"> </span>python_abi
<span class="w">  </span>├─<span class="w"> </span>python
<span class="w">  </span>├─<span class="w"> </span>numpy
<span class="w">  </span>└─<span class="w"> </span>arrow-cpp
</code></pre></div>
</details>
<details class="note">
<summary>PyArrow vendored libraries (PyPI wheels)</summary>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>pyarrow/*.so<span class="w">  </span><span class="c1"># pyarrow/ is from an unzipped manylinux wheel</span>
/home/rgommers/Downloads/pyarrow/_compute.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_csv.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_dataset.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_dataset_orc.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_dataset_parquet.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_exec_plan.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_feather.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_flight.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_fs.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_gcsfs.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_hdfs.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_hdfsio.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_json.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/libarrow_python_flight.so
/home/rgommers/Downloads/pyarrow/libarrow_python.so
/home/rgommers/Downloads/pyarrow/lib.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_orc.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_parquet.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_parquet_encryption.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_plasma.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_pyarrow_cpp_tests.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_s3fs.cpython-311-x86_64-linux-gnu.so
/home/rgommers/Downloads/pyarrow/_substrait.cpython-311-x86_64-linux-gnu.so
</code></pre></div>
</details>
<p>We see that <a href="https://github.com/apache/parquet-format">Apache Parquet</a> and
<a href="https://github.com/substrait-io/substrait">Substrait</a>, two separate
projects, have to be vendored, and a lot of Apache Arrow C++ components are
packed into a single wheel. What can't be seen from the wheel contents is
that some of the extension modules were built with other complex
dependencies like <code>protobuf</code> and <code>glog</code> (which therefore also need to be
built as part of the wheel build process). Such dependencies raise the
possibility of symbol conflicts when other packages are built with
different versions of those libraries, or in different ways. This can
result in hard to debug crashes or "undefined symbol" problems.
<a href="https://uwekorn.com/2019/09/15/how-we-build-apache-arrows-manylinux-wheels.html">This blog post by Uwe Korn</a>
describes some of the issues in detail, including problems installing
PyArrow side by side with TensorFlow and Turbodbc.</p>
</div>
<p>C++ ABI has been an issue for quite a while. Most C++ developers and projects
want to use the new ABI, however due to the old manylinux standard and
depending on <code>devtoolset</code> forces the use of the old C++ ABI
(<code>_GLIBCXX_USE_CXX11_ABI=0</code>). Projects using modern C++14/17 typically want
to use the new ABI. This is still quite difficult. It's now possible with
<code>manylinux_2_28</code>, but requires building duplicate sets of wheels<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> (also
<code>manylinux2014</code> for compatibility with older distros like Ubuntu 18.04 and
CentOS 8, that will still use the old ABI).</p>
<p>As an example: PyTorch added <code>libtorch</code> builds with the new ABI to its own
download server in 2019 already
(<a href="https://github.com/pytorch/pytorch/issues/17492">pytorch#17492</a>), however the
issue for matching wheels is still open
(<a href="https://github.com/pytorch/pytorch/issues/51039">pytorch#51039</a>) as of Dec '22.</p>
<p>An even thornier issue is the proliferation of Abseil in the API of projects
like <a href="https://developers.google.com/protocol-buffers/docs/news/2022-08-03">protobuf</a>,
given that Abseil's ABI is sensitive (by default) to the C++ standard version
being used to compile it, and this needs to be held consistent (essentially)
across the entire ecosystem. For more details, see <a href="../../../background/binary_interface/#abseil">here</a>.</p>
<h2 id="problems">Problems</h2>
<ul>
<li>
<p>Requirement for a wheel being completely self-contained, forcing vendoring of
  external C++ dependencies. Building external dependencies is a lot of effort,
  and error prone.</p>
<ul>
<li>It also prevents splitting up a wheel into multiple dependent ones. This
  may be desirable because of binary size or maintainability.</li>
</ul>
</li>
<li>
<p>The old C++ ABI still being the default.</p>
</li>
<li>Symbol clashes when different libraries vendor the same external dependency.</li>
</ul>
<h2 id="history">History</h2>
<p>Early history TODO.</p>
<p>The RAPIDS projects was forced to drop wheels completely from May 2019 to Oct
2022, because the <code>manylinux</code> required a too old C++ version, and made it
impossible to create compliant wheels with the RAPIDS C++14 code base. See
<a href="https://medium.com/rapids-ai/rapids-0-7-release-drops-pip-packages-47fc966e9472">this blog post for details</a>.</p>
<p>Apache Arrow's issues with wheels and the amount of effort they take were laid out
in detail in <a href="https://lists.apache.org/thread/mxvp4mcx01mvox8jckgszyg0h65ddlkn">this mailing list post by Wes McKinney</a>.</p>
<p><a href="https://github.com/pypa/packaging-problems/issues/25">This long discussion on <code>pypa/packaging-problems#25</code></a>
touches on many of the key pain points around wheels and projects with complex
C/C++ dependencies (interspersed with some "packaging politics").</p>
<h2 id="relevant-resources">Relevant resources</h2>
<p>TODO</p>
<h2 id="potential-solutions-or-mitigations">Potential solutions or mitigations</h2>
<ul>
<li>Better interaction/integration between PyPI/wheels/pip and other package
  managers, where dealing with C++ dependencies is easier.</li>
<li>... ?</li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>See <a href="https://github.com/pypa/manylinux/issues/1332">manylinux#1332</a>
and <a href="https://github.com/pytorch/pytorch/issues/51039#issuecomment-1183263853">pytorch#51039</a>
for details.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 30, 2022</span>
      
        <br>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 20, 2022</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 Quansight Labs & open source contributors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/pypackaging-native/pypackaging-native" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/pypackaging-native/pypackaging-native/blob/main/LICENSE" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 10a3.04 3.04 0 0 1 3-3 3.04 3.04 0 0 1 3 3 3.04 3.04 0 0 1-3 3 3.04 3.04 0 0 1-3-3m3 9 4 1v-3.08A7.54 7.54 0 0 1 12 18a7.54 7.54 0 0 1-4-1.08V20m4-16a5.78 5.78 0 0 0-4.24 1.74A5.78 5.78 0 0 0 6 10a5.78 5.78 0 0 0 1.76 4.23A5.78 5.78 0 0 0 12 16a5.78 5.78 0 0 0 4.24-1.77A5.78 5.78 0 0 0 18 10a5.78 5.78 0 0 0-1.76-4.26A5.78 5.78 0 0 0 12 4m8 6a8.04 8.04 0 0 1-.57 2.8A7.84 7.84 0 0 1 18 15.28V23l-6-2-6 2v-7.72A7.9 7.9 0 0 1 4 10a7.68 7.68 0 0 1 2.33-5.64A7.73 7.73 0 0 1 12 2a7.73 7.73 0 0 1 5.67 2.36A7.68 7.68 0 0 1 20 10Z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["header.autohide"], "search": "../../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.51d95adb.min.js"></script>
      
    
  </body>
</html>