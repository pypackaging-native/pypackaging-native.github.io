
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Distributing a package containing SIMD code - pypackaging-native</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#distributing-a-package-containing-simd-code" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="pypackaging-native" class="md-header__button md-logo" aria-label="pypackaging-native" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pypackaging-native
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Distributing a package containing SIMD code
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pypackaging-native/pypackaging-native" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="pypackaging-native" class="md-nav__button md-logo" aria-label="pypackaging-native" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    pypackaging-native
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pypackaging-native/pypackaging-native" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Meta topics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Meta topics" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Meta topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../meta-topics/build_steps_conceptual/" class="md-nav__link">
        Build & package management concepts and terminology
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../meta-topics/purposes_of_pypi/" class="md-nav__link">
        The multiple purposes of PyPI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../meta-topics/pypi_social_model/" class="md-nav__link">
        PyPI's author-led social model and its limitations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../meta-topics/no_build_farm/" class="md-nav__link">
        Lack of a build farm for PyPI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../meta-topics/user_expectations_wheels/" class="md-nav__link">
        Expectations that projects provide ever more wheels
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Key issues
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Key issues" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Key issues
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Native dependencies
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Native dependencies" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Native dependencies
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../native-dependencies/" class="md-nav__link">
        Native dependencies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../native-dependencies/blas_openmp/" class="md-nav__link">
        BLAS, LAPACK and OpenMP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../native-dependencies/geospatial_stack/" class="md-nav__link">
        The Geospatial stack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../native-dependencies/cpp_deps/" class="md-nav__link">
        Complex C++ dependencies
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../abi/" class="md-nav__link">
        Depending on packages for which an ABI matters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../gpus/" class="md-nav__link">
        Packaging projects with GPU code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../pypi_metadata_handling/" class="md-nav__link">
        Metadata handling on PyPI
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Distributing a package containing SIMD code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Distributing a package containing SIMD code
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#current-state" class="md-nav__link">
    Current state
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problems" class="md-nav__link">
    Problems
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#history" class="md-nav__link">
    History
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relevant-resources" class="md-nav__link">
    Relevant resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#potential-solutions-or-mitigations" class="md-nav__link">
    Potential solutions or mitigations
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../unexpected_fromsource_builds/" class="md-nav__link">
        Unsuspecting users getting failing from-source builds
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../other_issues/" class="md-nav__link">
        Other issues
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Background
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Background" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Background
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/binary_interface/" class="md-nav__link">
        Application Binary Interface (ABI)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../background/compilation_concepts/" class="md-nav__link">
        Basic code compilation concepts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        Glossary
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#current-state" class="md-nav__link">
    Current state
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problems" class="md-nav__link">
    Problems
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#history" class="md-nav__link">
    History
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relevant-resources" class="md-nav__link">
    Relevant resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#potential-solutions-or-mitigations" class="md-nav__link">
    Potential solutions or mitigations
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/pypackaging-native/pypackaging-native/edit/master/docs/key-issues/simd_support.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="distributing-a-package-containing-simd-code">Distributing a package containing SIMD code</h1>
<p><a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data">Single Instruction, Multiple Data</a>
(SIMD) instructions are instructions that are CPU-specific, and can yield
significant performance gains compared to regular, portable C/C++ code. Each
popular modern CPU architecture has its own SIMD instruction sets.</p>
<p>Using SIMD instructions in a Python package is quite difficult, because there
is no way to specify, in either metadata or wheel tags, what CPU features are
needed on the target machine in order to use a given wheel.</p>
<details class="question">
<summary>What does code containing SIMD instructions look like?</summary>
<p>This code fragment shows how to use a single SSE2 instruction on an x86-64 CPU.
It defines a <code>mul</code> function which multiplies two double precision floating
point vectors:
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;immintrin.h&gt;</span><span class="cp"></span>
<span class="kr">__m128d</span><span class="w"> </span><span class="n">mul</span><span class="p">(</span><span class="kr">__m128d</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kr">__m128d</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_mm_mul_pd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
If the CPU supports the instruction and the code gets compiled with the
needed compiler flag (<code>-msse2</code>), the <code>mul</code> function will work and will be
faster than using regular multiplication in C/C++.</p>
<p>As a more real-world example, here is a code fragment from a <code>sin</code> function
for 32-bit float data from NumPy code:
<div class="highlight"><pre><span></span><code><span class="cp">#if NPY_SIMD_F32 &amp;&amp; NPY_SIMD_FMA3</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is_mem_overlap</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<span class="w">        </span><span class="o">!</span><span class="n">npyv_loadable_stride_f32</span><span class="p">(</span><span class="n">ssrc</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">npyv_storable_stride_f32</span><span class="p">(</span><span class="n">sdst</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ssrc</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sdst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">simd_sincos_f32</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">SIMD_COMPUTE_SIN</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">simd_sincos_f32</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">ssrc</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="n">sdst</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">SIMD_COMPUTE_SIN</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="o">--</span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ssrc</span><span class="p">,</span><span class="w"> </span><span class="n">dst</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sdst</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">src0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">dst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">npy_sinf</span><span class="p">(</span><span class="n">src0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>
</code></pre></div></p>
</details>
<details class="question">
<summary>How important is use of SIMD code?</summary>
<p>Code with SIMD instructions is typically a lot more difficult to read and
maintain than regular C or C++ code. The speedups can be large however,
so the implementation effort and the maintenance burden may be worth it.
For basic and heavily used functionality like element-wise math functions
(<code>abs</code>, <code>sqrt</code>, <code>multiply</code>, etc.), typical gains are in the <code>1.x - 10</code> range,
and sometimes even <code>&gt;10</code>). Here are a few benchmark results for:</p>
<ul>
<li>OpenCV color conversion functionality, ~25x faster on ARM CPUs with NEON:
  <a href="https://github.com/opencv/opencv/pull/19883">opencv#19883</a></li>
<li>NumPy's <code>absolute</code>, <code>reciprocal</code>, <code>sqrt</code>, <code>square</code> functions, for
  SSE/AVX2 (x86-64), NEON (aarch64/arm64), and VSX (ppc64le):
  <a href="https://github.com/numpy/numpy/pull/16247">numpy#16247</a></li>
<li>PyTorch <code>softmax</code>, <code>min</code> and <code>max</code> 3x-4x faster for <code>bfloat16</code> with
  AVX2/AVX512 on x86-64:
  <a href="https://github.com/pytorch/pytorch/pull/55202#issuecomment-812284545">pytorch#55202</a>,
  and up to 2x-10x with <code>uint8</code> for <code>+</code>, <code>&gt;&gt;</code>, <code>min</code>:
  <a href="https://github.com/pytorch/pytorch/pull/89284#issuecomment-1323640288">pytorch#89284</a></li>
<li>Using AVX2 instead of SSE in SciPy's 2-D Fourier transforms:
  <a href="https://github.com/scipy/scipy/issues/16984">scipy#16984</a></li>
</ul>
<p>It is safe to say that performance gains that large, for single-threaded
execution in libraries that are so widely used, are extremely important.</p>
</details>
<h2 id="current-state">Current state</h2>
<p>As of December 2022, there is no support on PyPI, in the wheel spec, or in any
widely used packaging tool for binaries containing SIMD instructions. Nor a
plan to implement such support. The only relevant metadata is the "platform
compatibility tag" in a wheel name, first defined in <a href="https://peps.python.org/pep-0425/">PEP 425</a>
and now maintained under <a href="https://packaging.python.org/en/latest/specifications/platform-compatibility-tags/#platform-compatibility-tags">PyPA specifications in the Python Packaging User
Guide</a>.
A platform tag defines a CPU family, for example <code>x86_64</code> for 64-bit x86 CPUs
and <code>aarch64</code> for 64-bit ARM CPUs.</p>
<p>Projects that want to distribute wheels containing SIMD instructions have
effectively three choices:</p>
<ol>
<li>Make a single choice of SIMD instructions to include.</li>
<li>Build extension modules with multiple SIMD flavors inside, detect CPU
   capabilities at runtime, and then dynamically choose the optimal binary
   code.</li>
<li>Create separate packages on PyPI with a different package name but the same
   import name, and containing wheels with newer instructions. Then let users
   manually install those alternative packages.</li>
</ol>
<p>Choice (1) implicitly defines what CPUs are supported by their package. Given
that unsupported instructions result in very obscure errors, this means
targeting SIMD instruction sets that are at least 10 years old (sometimes more).
Choice (2) results in improved performance, because newer SIMD instructions can
be used. However, this comes at the cost of a large amount of code complexity
and larger wheel sizes.</p>
<p>In practice, only the largest and most widely used projects are able to make
choice (2). And they indeed do so - TensorFlow, PyTorch, OpenCV, NumPy, and
MXNet all have their own machinery and methods to work with SIMD instructions.</p>
<p>There are not many examples of choice (3). The ones that do exist, e.g.
<a href="https://github.com/uploadcare/pillow-simd">Pillow-SIMD</a> and
<a href="https://github.com/intel/scikit-learn-intelex">Intel(R) Extension for scikit-learn</a>,
tend to be forks by a third party rather than packages created by the original
development team.</p>
<p>Distributing binaries with SIMD instructions is not something many other packaging
systems have an answer for. The exception is Spack, which has builtin capabilities
through <a href="https://github.com/archspec/archspec"><code>archspec</code></a> for installing
optimized binaries. This will even be surfaced in its resolver; individual
package entries will contain a tag like <code>-skylake_avx512</code> (microarchitecture +
highest supported instruction set). The
<a href="https://tgamblin.github.io/pubs/archspec-canopie-hpc-2020.pdf"><code>archspec</code> paper</a>
is worth reading for a thorough discussion of the design aspects of integrating
support for SIMD instructions, and dealing with CPU compatibility in a
packaging system in a more granular fashion.</p>
<h2 id="problems">Problems</h2>
<p>Writing SIMD instructions is a specialized skill, however it can be effective
to do so in only a few performance hotspots of the code. So it is often
worthwhile, if it weren't for the problems around distributing wheels on PyPI.
To illustrate how prohibitively expensive in terms of developer time the
dynamic dispatch solution is: NumPy only gained support for it in 2020, and
SciPy still does not have it (it chooses SSE3 instructions, first released in
2005, as the most recent instructions that are allowed to be used on x86).</p>
<p>Less sophisticated methods employed in the wild are compiling the project twice
(e.g. once with SSE3 and once with AVX2), and defaulting to importing the latter
while falling back to the former. Obviously this doubles binary size.</p>
<p>The "distribute separate wheels under a different package name (choice 3 above)
is so user-unfriendly, and also fairly labor-intensive, that we cannot think of
a single open source project that does this on PyPI.</p>
<p>The "choose a baseline and compile only for that" (choice 1 above) is the
easiest choice that still allows using some SIMD instructions - and the
difference between some (e.g. up to SSE3) and none at all can still be very
large in terms of performance gain. However, this still leaves some users with
old or nonstandard CPUs out in the cold, and it forces package authors to come
up with a method for choosing that maximum feature set. The rule of thumb that
NumPy and SciPy came up with is: if the number of users with incompatible CPUs
stays below 0.5% (as determined by some publicly available data from browser
and gaming vendors), then it's okay to use a particular feature. This is not
ideal, but tends to lead to few complaints in practice.</p>
<h2 id="history">History</h2>
<p>Distributing packages containing SIMD code on PyPI came up a number of times on
the distutils-sig mailing list, as well as more recently on Discourse:</p>
<ul>
<li><a href="https://mail.python.org/pipermail/distutils-sig/2013-December/023238.html">Handling the binary dependency management problem</a>
  thread on distutils-sig (2013)</li>
<li><a href="https://mail.python.org/archives/list/distutils-sig@python.org/thread/4TXZXRVYKFTPJSWSSBOU4AWODM7YHF6N/#GR33CY6HJF5V36XG3R2IGWAB4LG4STFG">Warning about potential problems for wheels</a>
  thread on distutils-sig (2015)</li>
<li><a href="https://mail.python.org/archives/list/distutils-sig@python.org/thread/EFXFPZYKDPR74RJ7D7EKKRSILZRBZEDT/#TAOR6F2R2DVX5KDORMCGP4LAUC5HWT24">Status update on the NumPy &amp; SciPy vs SSE problem?</a>
  thread on distutils-sig (2016)</li>
<li><a href="https://discuss.python.org/t/archspec-a-library-for-labeling-optimized-binaries/3149">Archspec: a library for labeling optimized binaries</a>
  on a Packaging thread on Discourse (2020)</li>
<li><a href="https://discuss.python.org/t/idea-selector-packages/4463">Idea: selector packages</a>
  on a Packaging thread on Discourse (2020)</li>
</ul>
<p>Even before wheels existed, NumPy and SciPy were already distributing <code>.exe</code>
Windows installers for three SIMD flavors (no SIMD, up to SSE2, and up to SSE3,
see for example <a href="https://pypi.org/project/numpy/1.5.1/#files">pypi.org/project/numpy/1.5.1/#files</a>.</p>
<h2 id="relevant-resources">Relevant resources</h2>
<p>Links to key issues, forum discussions, PEPs, blog posts, etc.</p>
<ul>
<li><a href="https://numpy.org/neps/nep-0038-SIMD-optimizations.html">NEP 38 - Using SIMD optimization instructions for performance</a>
  (see also the "Related Work" section in that NEP for more relevant projects)</li>
<li><code>archspec</code> - a library for detecting, labeling, and reasoning about microarchitectures:
  <a href="https://github.com/archspec/archspec">GitHub repo</a>, <a href="https://tgamblin.github.io/pubs/archspec-canopie-hpc-2020.pdf">paper</a></li>
<li><code>pytorch/cpuinfo</code> - CPU INFOrmation library: <a href="https://github.com/pytorch/cpuinfo">GitHub repo</a></li>
<li><code>xsimd</code> - C++ wrappers for SIMD intrinsics and parallelized, optimized mathematical functions:
  <a href="https://github.com/xtensor-stack/xsimd">GitHub repo</a></li>
<li>Spack's <a href="https://spack.readthedocs.io/en/latest/basic_usage.html#support-for-specific-microarchitectures">docs on support for specific microarchitectures</a></li>
</ul>
<h2 id="potential-solutions-or-mitigations">Potential solutions or mitigations</h2>
<p>There are few potential solutions on the Python packaging side that look promising:</p>
<ul>
<li>New wheel tags for specific microarchitectures is a blunt instrument, and
  there are too many microarchitectures to consider for this to work well,</li>
<li>Using a library like <code>archspec</code> by packaging tools is very likely too complicated,</li>
<li>The <a href="https://discuss.python.org/t/idea-selector-packages/4463">selector packages idea</a>
  seemed promising at first, but seems to have fallen out of favor now.</li>
</ul>
<p>The most likely path forward to improve the current situation is to make it easier to
share and reuse infrastructure for CPU feature detection and runtime dispatch. With <code>archspec</code>
and <code>pytorch/cpuinfo</code> there are two solid libraries available for feature detection.
The NumPy and Meson projects are planning to collaborate to make the "multiple
compilation for different CPU capabilities" part available as a build system
feature. If the runtime dispatch part could be implemented as a standalone,
vendorable component, perhaps it will become easier for other projects to go
this route.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 30, 2022</span>
      
        <br>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 20, 2022</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../pypi_metadata_handling/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Metadata handling on PyPI" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Metadata handling on PyPI
            </div>
          </div>
        </a>
      
      
        
        <a href="../unexpected_fromsource_builds/" class="md-footer__link md-footer__link--next" aria-label="Next: Unsuspecting users getting failing from-source builds" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Unsuspecting users getting failing from-source builds
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 Quansight Labs & open source contributors
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/pypackaging-native/pypackaging-native" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://github.com/pypackaging-native/pypackaging-native/blob/main/LICENSE" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 10a3.04 3.04 0 0 1 3-3 3.04 3.04 0 0 1 3 3 3.04 3.04 0 0 1-3 3 3.04 3.04 0 0 1-3-3m3 9 4 1v-3.08A7.54 7.54 0 0 1 12 18a7.54 7.54 0 0 1-4-1.08V20m4-16a5.78 5.78 0 0 0-4.24 1.74A5.78 5.78 0 0 0 6 10a5.78 5.78 0 0 0 1.76 4.23A5.78 5.78 0 0 0 12 16a5.78 5.78 0 0 0 4.24-1.77A5.78 5.78 0 0 0 18 10a5.78 5.78 0 0 0-1.76-4.26A5.78 5.78 0 0 0 12 4m8 6a8.04 8.04 0 0 1-.57 2.8A7.84 7.84 0 0 1 18 15.28V23l-6-2-6 2v-7.72A7.9 7.9 0 0 1 4 10a7.68 7.68 0 0 1 2.33-5.64A7.73 7.73 0 0 1 12 2a7.73 7.73 0 0 1 5.67 2.36A7.68 7.68 0 0 1 20 10Z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["header.autohide"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>